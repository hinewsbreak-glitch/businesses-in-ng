<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSd4J2DFQf1bO7uNOyqlibecVqutzPyB2OuulWidDMG9w54C3YtgFiibOCTvzdMqUyRpc4pl6m9V3Cf/pub?gid=240874475&single=true&output=csv";

const listEl = document.getElementById("list");
const metaEl = document.getElementById("meta");
const loadingEl = document.getElementById("loading");
const errorEl = document.getElementById("error");
const searchEl = document.getElementById("search");
const stateFilterEl = document.getElementById("stateFilter");

let allRows = [];

function showError(msg) {
  loadingEl.style.display = "none";
  errorEl.style.display = "block";
  errorEl.innerHTML = msg;
}

function safe(v) {
  return (v ?? "").toString().trim();
}

function parseCSV(text) {
  const rows = [];
  const lines = text.split("\n");

  for (let line of lines) {
    const cols = line.split(",");
    rows.push(cols);
  }

  return rows;
}

function render(rows) {
  const q = safe(searchEl.value).toLowerCase();
  const state = stateFilterEl.value;

  const filtered = rows.filter(r => {
    const joined = r.join(" ").toLowerCase();
    const matchesSearch = joined.includes(q);
    const matchesState = !state || r[3] === state;
    return matchesSearch && matchesState;
  });

  listEl.innerHTML = "";

  filtered.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${safe(r[1])}</h3>
      <p><strong>Category:</strong> ${safe(r[2])}</p>
      <p><strong>State:</strong> ${safe(r[3])}</p>
      <p><strong>LGA:</strong> ${safe(r[4])}</p>
      <p><strong>Phone:</strong> ${safe(r[5])}</p>
    `;

    listEl.appendChild(card);
  });

  metaEl.innerHTML = `${filtered.length} businesses found`;
}

fetch(sheetURL)
  .then(res => {
    if (!res.ok) throw new Error("Network error");
    return res.text();
  })
  .then(text => {
    loadingEl.style.display = "none";
    const data = parseCSV(text);
    allRows = data.slice(1); // skip header
    render(allRows);
  })
  .catch(() => {
    showError("Could not load the sheet.");
  });

searchEl.addEventListener("input", () => render(allRows));
stateFilterEl.addEventListener("change", () => render(allRows));
</script>
